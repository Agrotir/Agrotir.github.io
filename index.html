<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/custom.css" rel="stylesheet" />
        <title>Streamlet</title>
    </head>

    <body>
        <div class="container">
            <h1>Number of peers: <span id="noOfPeers">0</span></h1>

            <p>Peer Select</p>
            <select class="form-select" id="peerSelect"></select>

            <hr />

            <button type="button" class="btn btn-primary" id="addPeer">
                Add Peer
            </button>
            <button type="button" class="btn btn-primary" id="startElection">
                Start Election
            </button>
            <button type="button" class="btn btn-primary" id="stopElection" disabled="true">
                Stop Election
            </button>

            <button
                type="button"
                class="btn btn-success"
                id="propose_invalid_block"
            >
                Propose Invalid Block
            </button>
            <button
                type="button"
                class="btn btn-success"
                id="sign_invalid_block"
            >
                Sign Invalid Block
            </button>
            <button
                type="button"
                class="btn btn-success"
                id="ignore_valid_block"
            >
                Ignore Valid Block
            </button>

            <hr />

            <div class="row" id="blockChain"></div>

            <script src="js/jquery-3.5.1.min.js"></script>
            <script src="js/sha256.js"></script>
            <script src="js/config.js"></script>
            <script src="js/bootstrap.bundle.min.js"></script>
            <script>

                var is_running = false;

                var timeout_id;

                var current_client = -1;
                var global_client_list = [];

                var epoch_number = 1;

                var blockchain_dictionary = {};
                blockchain_dictionary[0] = [new DictionaryEntry(0, [], 0)];
                blockchain_dictionary[0][0].isNotarised = true;
                blockchain_dictionary[0][0].isFinalised = true;

                var most_recent_finalised_block = "0";

                function Client() {
                    this.id = global_client_list.length;

                    this.propose_invalid_block = false;
                    this.sign_invalid_block = false;
                    this.ignore_valid_block = false;

                    this.payload_holding_area = [];
                }

                function Payload(data, sender, timestamp) {
                    this.data = data;
                    this.sender = sender;
                    this.timestamp = timestamp;
                }

                function DictionaryEntry(
                    epoch_number,
                    payloads,
                    previous_hash
                ) {
                    this.epoch_number = epoch_number;
                    this.payloads = payloads;
                    this.previous_hash = previous_hash;

                    this.signatures = [];

                    this.hash = sha256(
                        "" + epoch_number + payloads.toString() + previous_hash
                    );

                    this.isNotarised = false;
                    this.isFinalised = false;
                }

                $("#addPeer").click(function () {
                    global_client_list.push(new Client());

                    if (current_client == -1) {
                        current_client = 0;
                        $("#blockChain").append(
                            "<div class='col-2'><div class='card text-white bg-success' id='" +
                                blockchain_dictionary[0][0].hash +
                                "'><div class='card-body'><h5 class='card-title'><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-clock' vipreviousHashewBox='0 0 16 16'><path d='M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z'/><path d='M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z'/></svg> " +
                                blockchain_dictionary[0][0].epoch_number +
                                "</h5><p class='card-text'><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-calculator' viewBox='0 0 16 16'><path d='M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z'/><path d='M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z'/></svg> " +
                                truncateString(
                                    blockchain_dictionary[0][0].hash,
                                    16
                                ) +
                                "</p><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-arrow-90deg-left' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4z'/></svg> " +
                                truncateString(
                                    blockchain_dictionary[0][0].previous_hash,
                                    16
                                ) +
                                "</p><hr><p class='signatures'></p></p></div></div></div>"
                        );
                    }

                    $("#peerSelect").append(
                        "<option value='" +
                            (global_client_list.length - 1) +
                            "'>" +
                            global_client_list[global_client_list.length - 1]
                                .id +
                            "</option>"
                    );

                    $("#noOfPeers").text(global_client_list.length);
                });

                $("#peerSelect").on("change", function () {
                    current_client = this.value;
                    if (
                        global_client_list[current_client].propose_invalid_block
                    ) {
                        $("#propose_invalid_block").removeClass("btn-success");
                        $("#propose_invalid_block").addClass("btn-danger");
                    } else {
                        $("#propose_invalid_block").addClass("btn-success");
                        $("#propose_invalid_block").removeClass("btn-danger");
                    }

                    if (global_client_list[current_client].sign_invalid_block) {
                        $("#sign_invalid_block").removeClass("btn-success");
                        $("#sign_invalid_block").addClass("btn-danger");
                    } else {
                        $("#sign_invalid_block").addClass("btn-success");
                        $("#sign_invalid_block").removeClass("btn-danger");
                    }

                    if (global_client_list[current_client].ignore_valid_block) {
                        $("#ignore_valid_block").removeClass("btn-success");
                        $("#ignore_valid_block").addClass("btn-danger");
                    } else {
                        $("#ignore_valid_block").addClass("btn-success");
                        $("#ignore_valid_block").removeClass("btn-danger");
                    }
                });

                $("#startElection").click(function () {
                    is_running = true;
                    $("#addPeer").attr("disabled", true);
                    $("#startElection").attr("disabled", true);
                    $("#stopElection").attr("disabled", false);
                    timeout_id = setTimeout(function () {
                        epoch_actions();
                    }, calculate_time_to_next_epoch());
                });

                $("#stopElection").click(function () {
                    is_running = false;
                    $("#stopElection").attr("disabled", true);
                    $("#propose_invalid_block").attr("disabled", true);
                    $("#sign_invalid_block").attr("disabled", true);
                    $("#ignore_valid_block").attr("disabled", true);

                    while (timeout_id--) {
                        window.clearTimeout(timeout_id);
                    }
                });

                function epoch_actions() {
                    //next epoch

                    if (is_running) {
                        timeout_id= setTimeout(function () {
                            epoch_actions();
                        }, calculate_time_to_next_epoch());

                        for (var i = 0; i < global_client_list.length; i++) {
                            broadcast_payloads(i);
                        }
                    }

                    var current_epoch_time = new Date();
                    current_epoch_time.setSeconds(
                        current_epoch_time.getSeconds() -
                            (current_epoch_time.getSeconds() %
                                config.epoch_interval)
                    );

                    var leader =
                        global_client_list[get_leader(current_epoch_time)];

                    var array_of_furthest_hashes = recursive_get_furthest_hash(
                        blockchain_dictionary,
                        0,
                        0,
                        []
                    );

                    var selected_hash =
                        array_of_furthest_hashes[
                            Math.floor(
                                Math.random() * array_of_furthest_hashes.length
                            )
                        ];
                    var list_of_payloads_raw = recursive_get_payloads(
                        blockchain_dictionary,
                        selected_hash,
                        0,
                        []
                    );

                    var list_of_payloads = [];
                    for (var i = 0; i < list_of_payloads_raw[1].length; i++) {
                        for (
                            var j = 0;
                            j < list_of_payloads_raw[1][i].payloads.length;
                            j++
                        ) {
                            list_of_payloads.push(
                                list_of_payloads_raw[1][i].payloads[j]
                            );
                        }
                    }

                    var onlyInA = leader.payload_holding_area.filter(
                        comparer(list_of_payloads)
                    );
                    var onlyInB = list_of_payloads.filter(
                        comparer(leader.payload_holding_area)
                    );
                    var difference = onlyInA.concat(onlyInB);

                    var payloads_to_propose = [];
                    for (var i = 0; i < difference.length; i++) {
                        if (percentage_chance(config.payload_proposal_chance)) {
                            payloads_to_propose.push(difference[i]);
                        }
                    }

                    if (leader.propose_invalid_block) {
                        payloads_to_propose.unshift(
                            new Payload(
                                "fake:" + Math.round(Math.random() * 1000) / 1000,
                                leader.id,
                                new Date()
                            )
                        );
                    }

                    var new_block = new DictionaryEntry(
                        epoch_number,
                        payloads_to_propose,
                        selected_hash
                    );

                    $(document).trigger(
                        "block_proposal",
                        JSON.parse(
                            JSON.stringify({
                                sender: leader.id,
                                block: new_block,
                            })
                        )
                    );

                    epoch_number = epoch_number + 1;
                }

                function broadcast_payloads(i) {
                    if (percentage_chance(config.payload_chance)) {
                        var new_payload = new Payload(
                            Math.round(Math.random() * 1000) / 1000,
                            i,
                            new Date()
                        );
                        $(document).trigger(
                            "new_payload",
                            JSON.parse(
                                JSON.stringify({
                                    payload: new_payload,
                                })
                            )
                        );
                    }
                }

                function broadcast_signature(i, data) {
                    timeout_id = setTimeout(function () {
                        $(document).trigger(
                            "block_signature",
                            JSON.parse(
                                JSON.stringify({
                                    block: data.block,
                                    signature: i + "'s Signature",
                                })
                            )
                        );
                    }, getRandomArbitrary(
                        0,
                        config.signature_delay * config.epoch_interval
                    ) * 1000);
                }

                $(document).on("new_payload", function (event, data) {
                    for (var i = 0; i < global_client_list.length; i++) {
                        global_client_list[i].payload_holding_area.push(
                            data.payload
                        );
                    }
                });

                $(document).on("block_proposal", function (event, data) {
                    add_dictionary_entry(
                        blockchain_dictionary,
                        most_recent_finalised_block,
                        new DictionaryEntry(
                            data.block.epoch_number,
                            data.block.payloads,
                            data.block.previous_hash
                        )
                    );

                    for (var i = 0; i < global_client_list.length; i++) {
                        if (i == current_client) {
                            var new_HTML_block =
                                "<div class='col-2' style='margin-bottom:20px'><div class='card' id='" +
                                data.block.hash +
                                "'><div class='card-body'><h5 class='card-title'><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-clock' vipreviousHashewBox='0 0 16 16'><path d='M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z'/><path d='M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z'/></svg> " +
                                data.block.epoch_number +
                                "</h5><p class='card-text'><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-calculator' viewBox='0 0 16 16'><path d='M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z'/><path d='M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z'/></svg> " +
                                truncateString(data.block.hash, 16) +
                                "</p><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-arrow-90deg-left' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4z'/></svg> " +
                                truncateString(data.block.previous_hash, 16) +
                                "</p><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-list-check' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3.854 2.146a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 3.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 7.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0z'/></svg> <span class='signatures'>0</span> / " +
                                global_client_list.length +
                                "</p><a class='btn btn-secondary' onclick='toggle_payloads(this)'>Payloads</a><span class='payloads' style='display:none;'>";
                            for (
                                var j = 0;
                                j < data.block.payloads.length;
                                j++
                            ) {
                                new_HTML_block +=
                                    "<hr><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-basket3' viewBox='0 0 16 16'><path d='M5.757 1.071a.5.5 0 0 1 .172.686L3.383 6h9.234L10.07 1.757a.5.5 0 1 1 .858-.514L13.783 6H15.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 .5 6h1.717L5.07 1.243a.5.5 0 0 1 .686-.172zM3.394 15l-1.48-6h-.97l1.525 6.426a.75.75 0 0 0 .729.574h9.606a.75.75 0 0 0 .73-.574L15.056 9h-.972l-1.479 6h-9.21z'/></svg> " +
                                        data.block.payloads[j].data +
                                    "</p><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-person' viewBox='0 0 16 16'><path d='M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z'/></svg> " +
                                    data.block.payloads[j].sender +
                                    "</p><p><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-calendar3' viewBox='0 0 16 16'><path d='M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z'/><path d='M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z'/></svg> " +
                                    new Date(
                                        data.block.payloads[j].timestamp
                                    ).toLocaleString() +
                                    "</p>";
                            }
                            new_HTML_block += "</span></div></div></div>";

                            $("#blockChain").append(new_HTML_block);
                        }

                        var list_of_payloads_raw = recursive_get_payloads(
                            blockchain_dictionary,
                            data.block.previous_hash,
                            0,
                            []
                        );

                        var list_of_payloads = [];
                        for (
                            var j = 0;
                            j < list_of_payloads_raw[1].length;
                            j++
                        ) {
                            for (
                                var k = 0;
                                k < list_of_payloads_raw[1][j].payloads.length;
                                k++
                            ) {
                                list_of_payloads.push(
                                    list_of_payloads_raw[1][j].payloads[k]
                                );
                            }
                        }

                        let difference = global_client_list[
                            i
                        ].payload_holding_area.filter(
                            (x) => !list_of_payloads.includes(x)
                        );

                        var isSubset = true;

                        for (var j = 0; j < data.block.payloads.length; j++) {
                            var isFound = false;
                            for (var k = 0; k < difference.length; k++) {
                                if (
                                    JSON.stringify(
                                        data.block.payloads[j].data
                                    ) == JSON.stringify(difference[k].data)
                                ) {
                                    if (
                                        JSON.stringify(
                                            data.block.payloads[j].sender
                                        ) ==
                                        JSON.stringify(difference[k].sender)
                                    ) {
                                        if (
                                            JSON.stringify(
                                                data.block.payloads[j].timestamp
                                            ) ==
                                            JSON.stringify(
                                                difference[k].timestamp
                                            )
                                        ) {
                                            isFound = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (!isFound) {
                                isSubset = false;
                                break;
                            }
                        }

                        if (isSubset) {
                            if (!global_client_list[i].ignore_valid_block) {
                                broadcast_signature(i, data);
                            }
                        } else if (global_client_list[i].sign_invalid_block) {
                            broadcast_signature(i, data);
                        }
                    }
                });

                $(document).on("block_signature", function (event, data) {
                    $("#" + data.block.hash + " .signatures").text(
                        parseInt(
                            $("#" + data.block.hash + " .signatures")
                                .text()
                                .replace(/[^\d.]/g, "")
                        ) + 1
                    );

                    for (
                        var i = 0;
                        i <
                        blockchain_dictionary[data.block.previous_hash].length;
                        i++
                    ) {
                        if (
                            blockchain_dictionary[data.block.previous_hash][i]
                                .hash == data.block.hash
                        ) {
                            blockchain_dictionary[data.block.previous_hash][
                                i
                            ].signatures.push(data.signature);

                            if (
                                blockchain_dictionary[data.block.previous_hash][
                                    i
                                ].signatures.length >=
                                    (global_client_list.length * 2) / 3 &&
                                blockchain_dictionary[data.block.previous_hash][
                                    i
                                ].isNotarised == false
                            ) {
                                blockchain_dictionary[data.block.previous_hash][
                                    i
                                ].isNotarised = true;
                                $("#" + data.block.hash).addClass(
                                    "text-white bg-info"
                                );

                                console.log(blockchain_dictionary);

                                var end_of_finalised_chain = check_finalize(
                                    blockchain_dictionary,
                                    0,
                                    0,
                                    0,
                                    0,
                                    0,
                                    [false, 0]
                                );

                                if (end_of_finalised_chain[0]) {
                                    console.log(end_of_finalised_chain[1]);
                                    most_recent_finalised_block =
                                        end_of_finalised_chain[1];

                                    update_finality(
                                        blockchain_dictionary,
                                        0,
                                        end_of_finalised_chain[1]
                                    );
                                }
                            }
                            break;
                        }
                    }
                });

                $("#propose_invalid_block").click(function () {
                    global_client_list[
                        current_client
                    ].propose_invalid_block = !global_client_list[
                        current_client
                    ].propose_invalid_block;
                    if (
                        global_client_list[current_client].propose_invalid_block
                    ) {
                        $("#propose_invalid_block").removeClass("btn-success");
                        $("#propose_invalid_block").addClass("btn-danger");
                    } else {
                        $("#propose_invalid_block").addClass("btn-success");
                        $("#propose_invalid_block").removeClass("btn-danger");
                    }
                });
                $("#sign_invalid_block").click(function () {
                    global_client_list[
                        current_client
                    ].sign_invalid_block = !global_client_list[current_client]
                        .sign_invalid_block;
                    if (global_client_list[current_client].sign_invalid_block) {
                        $("#sign_invalid_block").removeClass("btn-success");
                        $("#sign_invalid_block").addClass("btn-danger");
                    } else {
                        $("#sign_invalid_block").addClass("btn-success");
                        $("#sign_invalid_block").removeClass("btn-danger");
                    }
                });
                $("#ignore_valid_block").click(function () {
                    global_client_list[
                        current_client
                    ].ignore_valid_block = !global_client_list[current_client]
                        .ignore_valid_block;
                    if (global_client_list[current_client].ignore_valid_block) {
                        $("#ignore_valid_block").removeClass("btn-success");
                        $("#ignore_valid_block").addClass("btn-danger");
                    } else {
                        $("#ignore_valid_block").addClass("btn-success");
                        $("#ignore_valid_block").removeClass("btn-danger");
                    }
                });

                function truncateString(str, length) {
                    return str.length > length
                        ? str.substring(0, length - 3) + "..."
                        : str;
                }

                function percentage_chance(percentage) {
                    if (Math.random() < percentage) {
                        return true;
                    }
                    return false;
                }

                function getRandomArbitrary(min, max) {
                    return Math.random() * (max - min) + min;
                }

                function comparer(otherArray) {
                    return function (current) {
                        return (
                            otherArray.filter(function (other) {
                                return (
                                    JSON.stringify(other.data) ==
                                        JSON.stringify(current.data) &&
                                    JSON.stringify(other.sender) ==
                                        JSON.stringify(current.sender) &&
                                    JSON.stringify(other.timestamp) ==
                                        JSON.stringify(current.timestamp)
                                );
                            }).length == 0
                        );
                    };
                }

                function calculate_next_time() {
                    var nextTime = new Date();
                    nextTime.setSeconds(
                        nextTime.getSeconds() + config.epoch_interval
                    );
                    nextTime.setSeconds(
                        nextTime.getSeconds() -
                            (nextTime.getSeconds() % config.epoch_interval)
                    );

                    return nextTime;
                }

                function calculate_time_to_next_epoch() {
                    var time_to_wait =
                        calculate_next_time().getTime() - new Date().getTime();
                    return time_to_wait;
                }

                function get_leader(date) {
                    var date_hash = sha256(date);
                    var sum = 0;
                    for (var i = 0; i < date_hash.length; i++) {
                        sum += date_hash.charCodeAt(i);
                    }
                    return sum % global_client_list.length;
                }

                function toggle_payloads(clicked_button) {
                    $(clicked_button).siblings(".payloads").slideToggle();
                }

                function add_dictionary_entry(
                    blockchain_dictionary,
                    current_key,
                    new_entry
                ) {
                    if (
                        typeof blockchain_dictionary[current_key] !==
                        "undefined"
                    ) {
                        for (
                            var i = 0;
                            i < blockchain_dictionary[current_key].length;
                            i++
                        ) {
                            if (
                                blockchain_dictionary[current_key][i].hash ==
                                new_entry.previous_hash
                            ) {
                                if (
                                    typeof blockchain_dictionary[
                                        new_entry.previous_hash
                                    ] == "undefined"
                                ) {
                                    blockchain_dictionary[
                                        new_entry.previous_hash
                                    ] = [];
                                }
                                blockchain_dictionary[
                                    new_entry.previous_hash
                                ].push(new_entry);
                                return true;
                            }
                            var found = add_dictionary_entry(
                                blockchain_dictionary,
                                blockchain_dictionary[current_key][i].hash,
                                new_entry
                            );
                            if (found) {
                                return true;
                            }
                        }
                    }
                }

                var highest_level_recursive_get_furthest_hash = 0;

                function recursive_get_furthest_hash(
                    blockchain_dictionary,
                    current_key,
                    current_level,
                    things_to_return
                ) {
                    if (
                        typeof blockchain_dictionary[current_key] !==
                        "undefined"
                    ) {
                        for (
                            var i = 0;
                            i < blockchain_dictionary[current_key].length;
                            i++
                        ) {
                            if (
                                blockchain_dictionary[current_key][i]
                                    .isNotarised
                            ) {
                                if (
                                    current_level >
                                    highest_level_recursive_get_furthest_hash
                                ) {
                                    highest_level_recursive_get_furthest_hash = current_level;
                                    things_to_return.splice(
                                        0,
                                        things_to_return.length
                                    );

                                    things_to_return.push(
                                        blockchain_dictionary[current_key][i]
                                            .hash
                                    );
                                } else if (
                                    current_level ==
                                    highest_level_recursive_get_furthest_hash
                                ) {
                                    things_to_return.push(
                                        blockchain_dictionary[current_key][i]
                                            .hash
                                    );
                                }
                            }

                            things_to_return = recursive_get_furthest_hash(
                                blockchain_dictionary,
                                blockchain_dictionary[current_key][i].hash,
                                current_level + 1,
                                things_to_return
                            );
                        }
                    }
                    return things_to_return;
                }

                function recursive_get_payloads(
                    blockchain_dictionary,
                    ending_key,
                    current_key,
                    things_to_return
                ) {
                    if (
                        typeof blockchain_dictionary[current_key] !==
                        "undefined"
                    ) {
                        for (
                            var i = 0;
                            i < blockchain_dictionary[current_key].length;
                            i++
                        ) {
                            things_to_return.push(
                                blockchain_dictionary[current_key][i]
                            );
                            if (
                                blockchain_dictionary[current_key][i].hash ===
                                ending_key
                            ) {
                                return [true, things_to_return];
                            } else {
                                var returnedValues = recursive_get_payloads(
                                    blockchain_dictionary,
                                    ending_key,
                                    blockchain_dictionary[current_key][i].hash,
                                    things_to_return
                                );
                                if (returnedValues[0] == true) {
                                    return [true, things_to_return];
                                } else {
                                    things_to_return.pop();
                                }
                            }
                        }
                    }
                    return [false, things_to_return];
                }

                var highest_level_recursive_check_finalize = 0;

                function check_finalize(
                    blockchain_dictionary,
                    current_key,
                    current_epoch,
                    current_key_minus_1,
                    current_epoch_minus_1,
                    current_level,
                    last_finalized
                ) {
                    if (
                        typeof blockchain_dictionary[current_key] !==
                        "undefined"
                    ) {
                        for (
                            var i = 0;
                            i < blockchain_dictionary[current_key].length;
                            i++
                        ) {
                            if (
                                blockchain_dictionary[current_key][i]
                                    .isNotarised
                            ) {
                                if (
                                    current_level >
                                    highest_level_recursive_check_finalize
                                ) {
                                    if (
                                        blockchain_dictionary[current_key][i]
                                            .epoch_number -
                                            1 ==
                                            current_epoch &&
                                        current_epoch - 1 ==
                                            current_epoch_minus_1
                                    ) {
                                        highest_level_recursive_check_finalize = current_level;
                                        last_finalized = [true, current_key];
                                    }
                                }
                            }
                            var last_finalized = check_finalize(
                                blockchain_dictionary,
                                blockchain_dictionary[current_key][i].hash,
                                blockchain_dictionary[current_key][i]
                                    .epoch_number,
                                current_key,
                                current_epoch,
                                current_level + 1,
                                last_finalized
                            );
                        }
                    }
                    return last_finalized;
                }

                function update_finality(
                    blockchain_dictionary,
                    current_key,
                    last_key
                ) {
                    if (
                        typeof blockchain_dictionary[current_key] !==
                        "undefined"
                    ) {
                        for (
                            var i = 0;
                            i < blockchain_dictionary[current_key].length;
                            i++
                        ) {
                            if (
                                blockchain_dictionary[current_key][i]
                                    .isNotarised
                            ) {
                                var found = update_finality(
                                    blockchain_dictionary,
                                    blockchain_dictionary[current_key][i].hash,
                                    last_key
                                );

                                if (found) {
                                    blockchain_dictionary[current_key][
                                        i
                                    ].isFinalised = true;

                                    $(
                                        "#" +
                                            blockchain_dictionary[current_key][
                                                i
                                            ].hash
                                    ).removeClass("text-white bg-info");

                                    $(
                                        "#" +
                                            blockchain_dictionary[current_key][
                                                i
                                            ].hash
                                    ).addClass("text-white bg-success");

                                    return true;
                                }

                                if (
                                    blockchain_dictionary[current_key][i]
                                        .hash == last_key
                                ) {
                                    blockchain_dictionary[current_key][
                                        i
                                    ].isFinalised = true;

                                    $(
                                        "#" +
                                            blockchain_dictionary[current_key][
                                                i
                                            ].hash
                                    ).removeClass("text-white bg-info");

                                    $(
                                        "#" +
                                            blockchain_dictionary[current_key][
                                                i
                                            ].hash
                                    ).addClass("text-white bg-success");

                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                }
            </script>
        </div>
    </body>
</html>
